---
title: "Firebase多要素認証におけるメールアドレス変更の仕様"
date: 2022-12-27
categories: ["Swift"]
tags: ["Swift", "Firebase"]
---

Firebase多要素認証を導入したことで、メールアドレス変更後にログアウトしたりとメールアドレス変更周りの動作に違いがあったので、検証しました。

iOSで検証してはいますが、Androidでも同じ仕様のようです。

(Firebase ver10.2.0)

## メールアドレス変更

### 多要素認証関係ない仕様

変更には直近(大体10分以内)の認証が必要です。

メールアドレス変更直前に再度ログインさせるのが無難です。

ログインから時間が経過しすぎるとエラーとして`.requiresRecentLogin`が返ってきます。

また、メールアドレス変更のメソッドを実行すると確認メールが届き、リンクをタップし次第メールアドレス変更が確定となります。

具体的には、
1. 新しいメールアドレスに確認メールが届く。確認メールのリンクタップで変更が確定。
2. 変更確定すると、古いメールアドレスにメールアドレスが変更されたというお知らせメールが届く。
3. もしお知らせメールのリンクをタップすると、メールアドレスが古い方に戻る。

### 多要素認証導入前

```swift
func changeEmail(email: String) async throws {
    try await Auth.auth().currentUser?.updateEmail(to: email)
}
```

### 多要素認証導入後

```swift
func changeEmail(email: String) async throws {
    try await Auth.auth().currentUser?.sendEmailVerification(beforeUpdatingEmail: email)
}
```

多要素認証を導入すると、メールアドレス変更が確定すると強制ログアウトされる、という仕様が追加されます。

1. 新しいメールアドレスに確認メールが届く。確認メールのリンクタップで変更が確定。
   →強制ログアウト
2. 変更確定すると、古いメールアドレスにメールアドレスが変更されたというお知らせメールが届く。
3. もしお知らせメールのリンクをタップすると、メールアドレスが古い方に戻る。
   →もしここでタップしたらまた強制ログアウト

ログアウト、と言ってもリアルタイムではなく、Authが認証情報を再読み込みするタイミング?(詳細不明)で`Auth.auth().currentUser`がnilになってしまいます。

`Auth.auth().currentUser.reload`で強制再読み込みさせれば、最新のログイン状態が取れます。

メールアドレス変更後は、`Auth.auth().currentUser.reload`を実行し再ログインさせるのが良さそうです。

（また、確認メールをタップするのはいつでもできてしまうので、変なタイミングでログアウトしても大丈夫なようにアプリを設計した方が良さそうです。）